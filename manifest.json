{
  "id": "rivestream-correct",
  "name": "Rivestream (Correct URLs)",
  "version": "1.0.4",
  "manifestURI": "https://raw.githubusercontent.com/Farqiplier/MyTestExtension/refs/heads/main/manifest.json",
  "language": "javascript",
  "type": "onlinestream-provider",
  "description": "Rivestream provider with correct API URLs",
  "author": "Farqiplier",
  "lang": "en",
  "payload": "/// <reference path=\"./online-streaming-provider.d.ts\" />\n\nclass Provider {\n  constructor() {\n    this.tmdbApiKey = \"963152cd5dd145cfa7496a5e975139e9\";\n  }\n\n  getSettings() {\n    return {\n      episodeServers: [\"Rivestream\"],\n      supportsDub: false,\n    };\n  }\n\n  async search(query) {\n    try {\n      console.log(\"[Rivestream] Search called with:\", JSON.stringify(query));\n      \n      const title = query.media?.title?.english || query.media?.title?.romaji || query.query;\n      const year = query.media?.seasonYear;\n      const isMovie = query.media?.format === \"MOVIE\";\n      const mediaType = isMovie ? \"movie\" : \"tv\";\n      \n      console.log(`[Rivestream] Searching for: \"${title}\" (${year || \"no year\"})`);\n      \n      let tmdbId = query.media?.idMal;\n      \n      if (!tmdbId || tmdbId === 0) {\n        console.log(\"[Rivestream] No TMDB ID from Simkl, searching TMDB...\");\n        \n        const searchUrl = `https://api.themoviedb.org/3/search/${mediaType}?api_key=${this.tmdbApiKey}&query=${encodeURIComponent(title)}&year=${year || \"\"}`;\n        const response = await fetch(searchUrl);\n        const data = await response.json();\n        \n        if (!data.results || data.results.length === 0) {\n          console.log(\"[Rivestream] No TMDB results\");\n          return [];\n        }\n        \n        tmdbId = data.results[0].id;\n      }\n      \n      console.log(`[Rivestream] Found TMDB ID: ${tmdbId}`);\n      \n      return [{\n        id: `${tmdbId}/${mediaType}`,\n        title: title,\n        url: `https://www.themoviedb.org/${mediaType}/${tmdbId}`,\n        subOrDub: \"sub\",\n      }];\n    } catch (err) {\n      console.error(\"[Rivestream] Search error:\", err);\n      return [];\n    }\n  }\n\n  async findEpisodes(Id) {\n    try {\n      console.log(`[Rivestream] findEpisodes: ${Id}`);\n      \n      const [tmdbId, mediaType] = Id.split(\"/\");\n      \n      if (mediaType === \"movie\") {\n        return [{ id: Id, number: 1, title: \"Movie\", url: \"\" }];\n      }\n      \n      const tvUrl = `https://api.themoviedb.org/3/tv/${tmdbId}?api_key=${this.tmdbApiKey}`;\n      const response = await fetch(tvUrl);\n      const tvData = await response.json();\n      \n      if (!tvData || !tvData.number_of_seasons) {\n        console.log(\"[Rivestream] Failed to get TV data\");\n        return [];\n      }\n      \n      console.log(`[Rivestream] Found ${tvData.number_of_seasons} seasons`);\n      \n      const episodes = [];\n      let absoluteEpisodeNumber = 1;\n      \n      for (let season = 1; season <= tvData.number_of_seasons; season++) {\n        const seasonUrl = `https://api.themoviedb.org/3/tv/${tmdbId}/season/${season}?api_key=${this.tmdbApiKey}`;\n        const seasonResponse = await fetch(seasonUrl);\n        const seasonData = await seasonResponse.json();\n        \n        if (!seasonData || !seasonData.episodes) continue;\n        \n        for (const ep of seasonData.episodes) {\n          episodes.push({\n            id: `${Id}/${season}/${ep.episode_number}`,\n            number: absoluteEpisodeNumber,\n            title: ep.name || `Episode ${absoluteEpisodeNumber}`,\n            url: \"\",\n          });\n          absoluteEpisodeNumber++;\n        }\n      }\n      \n      console.log(`[Rivestream] Found ${episodes.length} total episodes`);\n      return episodes;\n    } catch (err) {\n      console.error(\"[Rivestream] findEpisodes error:\", err);\n      return [];\n    }\n  }\n\n  async findEpisodeServer(episode, server) {\n    try {\n      console.log(`[Rivestream] findEpisodeServer: ${episode.id}`);\n      \n      const parts = episode.id.split(\"/\");\n      const tmdbId = parts[0];\n      const mediaType = parts[1];\n      const season = parts[2];\n      const ep = parts[3];\n      \n      let embedUrl;\n      \n      // FIXED: Using correct Rivestream API format\n      if (mediaType === \"movie\") {\n        embedUrl = `https://rivestream.org/embed?type=movie&id=${tmdbId}`;\n      } else {\n        embedUrl = `https://rivestream.org/embed?type=tv&id=${tmdbId}&season=${season}&episode=${ep}`;\n      }\n      \n      console.log(`[Rivestream] Correct embed URL: ${embedUrl}`);\n      \n      // Try to extract the actual HLS stream from the embed\n      let streamUrl = null;\n      try {\n        streamUrl = await this.extractStream(embedUrl);\n        console.log(`[Rivestream] Extracted stream: ${streamUrl ? streamUrl.substring(0, 50) + '...' : 'null'}`);\n      } catch (err) {\n        console.warn(`[Rivestream] Stream extraction failed:`, err);\n      }\n      \n      // If we got a stream URL, return it as HLS\n      if (streamUrl) {\n        return {\n          server: server,\n          headers: {\n            \"Referer\": \"https://rivestream.org/\",\n            \"Origin\": \"https://rivestream.org\",\n            \"User-Agent\": \"Mozilla/5.0\",\n          },\n          videoSources: [{\n            url: streamUrl,\n            type: \"hls\",\n            quality: \"auto\",\n            subtitles: [],\n          }],\n        };\n      }\n      \n      // Otherwise return as embed/iframe\n      console.log(`[Rivestream] Using embed (no direct stream found)`);\n      return {\n        server: server,\n        headers: {\n          \"Referer\": \"https://rivestream.org/\",\n        },\n        videoSources: [{\n          url: embedUrl,\n          type: \"embed\",\n          quality: \"auto\",\n          subtitles: [],\n        }],\n      };\n    } catch (err) {\n      console.error(\"[Rivestream] findEpisodeServer error:\", err);\n      throw new Error(`Failed to get stream: ${err.message}`);\n    }\n  }\n\n  async extractStream(embedUrl) {\n    try {\n      console.log(`[Rivestream] Fetching embed page...`);\n      \n      const response = await fetch(embedUrl, {\n        headers: {\n          \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36\",\n          \"Referer\": \"https://rivestream.org/\",\n        },\n      });\n      \n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}`);\n      }\n      \n      const html = await response.text();\n      console.log(`[Rivestream] Got embed page, length: ${html.length}`);\n      \n      // Try multiple patterns to find stream URL\n      \n      // Pattern 1: Look for .m3u8 URLs\n      let match = html.match(/https?:\\/\\/[^\\s\"']+\\.m3u8[^\\s\"']*/gi);\n      if (match && match[0]) {\n        console.log(`[Rivestream] Found m3u8 via pattern 1`);\n        return match[0];\n      }\n      \n      // Pattern 2: Look for file: \"...\" pattern\n      match = html.match(/[\"']file[\"']\\s*:\\s*[\"']([^\"']+)[\"']/i);\n      if (match && match[1]) {\n        console.log(`[Rivestream] Found stream via pattern 2`);\n        return match[1];\n      }\n      \n      // Pattern 3: Look for src: \"...\" pattern\n      match = html.match(/[\"']src[\"']\\s*:\\s*[\"']([^\"']+)[\"']/i);\n      if (match && match[1] && !match[1].includes('iframe')) {\n        console.log(`[Rivestream] Found stream via pattern 3`);\n        return match[1];\n      }\n      \n      // Pattern 4: Look for source tags\n      match = html.match(/<source[^>]+src=[\"']([^\"']+)[\"']/i);\n      if (match && match[1]) {\n        console.log(`[Rivestream] Found stream via pattern 4`);\n        return match[1];\n      }\n      \n      // Pattern 5: Look for player setup with sources array\n      match = html.match(/sources\\s*:\\s*\\[\\s*{[^}]*url\\s*:\\s*[\"']([^\"']+)[\"']/i);\n      if (match && match[1]) {\n        console.log(`[Rivestream] Found stream via pattern 5`);\n        return match[1];\n      }\n      \n      console.log(`[Rivestream] No stream URL found in embed page`);\n      return null;\n    } catch (err) {\n      console.error(`[Rivestream] Extract stream error:`, err);\n      return null;\n    }\n  }\n}"
}
