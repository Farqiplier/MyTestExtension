{
  "id": "multi-provider",
  "name": "Multi-Source Provider",
  "version": "1.0.0",
  "manifestURI": "https://raw.githubusercontent.com/Farqiplier/MyTestExtension/refs/heads/main/manifest.json",
  "language": "javascript",
  "type": "onlinestream-provider",
  "description": "Multi-source provider with fallbacks - Movies, TV, Anime",
  "author": "Farqiplier",
  "lang": "en",
  "payload": "/// <reference path=\"./online-streaming-provider.d.ts\" />\n\nclass Provider {\n  constructor() {\n    this.tmdbApiKey = \"963152cd5dd145cfa7496a5e975139e9\";\n  }\n\n  getSettings() {\n    return {\n      episodeServers: [\"VidSrc.to\", \"VidSrc.cc\", \"2Embed\", \"SuperEmbed\"],\n      supportsDub: false,\n    };\n  }\n\n  async search(query) {\n    try {\n      console.log(\"[MultiProvider] Search called with:\", JSON.stringify(query));\n      \n      const title = query.media?.title?.english || query.media?.title?.romaji || query.query;\n      const year = query.media?.seasonYear;\n      const isMovie = query.media?.format === \"MOVIE\";\n      const mediaType = isMovie ? \"movie\" : \"tv\";\n      \n      console.log(`[MultiProvider] Searching TMDB for: \"${title}\" (${year}), type: ${mediaType}`);\n      \n      let tmdbId = query.media?.idMal;\n      \n      if (!tmdbId || tmdbId === 0) {\n        console.log(\"[MultiProvider] No TMDB ID from Simkl, searching TMDB directly...\");\n        \n        const searchUrl = `https://api.themoviedb.org/3/search/${mediaType}?api_key=${this.tmdbApiKey}&query=${encodeURIComponent(title)}&year=${year || \"\"}`;\n        console.log(`[MultiProvider] TMDB Search URL: ${searchUrl}`);\n        \n        const response = await fetch(searchUrl);\n        const data = await response.json();\n        \n        console.log(`[MultiProvider] TMDB returned:`, data);\n        \n        if (!data.results || data.results.length === 0) {\n          console.log(\"[MultiProvider] No TMDB results found\");\n          return [];\n        }\n        \n        // Return multiple results so user can choose\n        const results = data.results.slice(0, 5).map(item => {\n          const itemYear = item.release_date ? new Date(item.release_date).getFullYear() : \n                          (item.first_air_date ? new Date(item.first_air_date).getFullYear() : null);\n          const itemTitle = item.title || item.name;\n          \n          console.log(`[MultiProvider] Found: ${itemTitle} (${itemYear}), TMDB ID: ${item.id}`);\n          \n          return {\n            id: `${item.id}/${mediaType}`,\n            title: `${itemTitle}${itemYear ? ` (${itemYear})` : \"\"}`,\n            url: `https://www.themoviedb.org/${mediaType}/${item.id}`,\n            subOrDub: \"sub\",\n          };\n        });\n        \n        console.log(`[MultiProvider] Returning ${results.length} results`);\n        return results;\n      } else {\n        console.log(`[MultiProvider] Using TMDB ID from Simkl: ${tmdbId}`);\n        \n        // Get the title from TMDB to confirm\n        const detailsUrl = `https://api.themoviedb.org/3/${mediaType}/${tmdbId}?api_key=${this.tmdbApiKey}`;\n        const response = await fetch(detailsUrl);\n        const data = await response.json();\n        \n        const itemTitle = data.title || data.name || title;\n        const itemYear = data.release_date ? new Date(data.release_date).getFullYear() : \n                        (data.first_air_date ? new Date(data.first_air_date).getFullYear() : null);\n        \n        console.log(`[MultiProvider] TMDB details: ${itemTitle} (${itemYear})`);\n        \n        return [{\n          id: `${tmdbId}/${mediaType}`,\n          title: `${itemTitle}${itemYear ? ` (${itemYear})` : \"\"}`,\n          url: `https://www.themoviedb.org/${mediaType}/${tmdbId}`,\n          subOrDub: \"sub\",\n        }];\n      }\n    } catch (err) {\n      console.error(\"[MultiProvider] Search error:\", err);\n      return [];\n    }\n  }\n\n  async findEpisodes(Id) {\n    try {\n      console.log(`[MultiProvider] findEpisodes: ${Id}`);\n      \n      const [tmdbId, mediaType] = Id.split(\"/\");\n      \n      if (mediaType === \"movie\") {\n        console.log(`[MultiProvider] This is a movie, returning single episode`);\n        return [{ id: Id, number: 1, title: \"Movie\", url: \"\" }];\n      }\n      \n      console.log(`[MultiProvider] Fetching TV show data from TMDB...`);\n      const tvUrl = `https://api.themoviedb.org/3/tv/${tmdbId}?api_key=${this.tmdbApiKey}`;\n      const response = await fetch(tvUrl);\n      const tvData = await response.json();\n      \n      if (!tvData || !tvData.number_of_seasons) {\n        console.error(\"[MultiProvider] No TV data found\");\n        return [];\n      }\n      \n      console.log(`[MultiProvider] Found ${tvData.number_of_seasons} seasons`);\n      \n      const episodes = [];\n      let absoluteEpisodeNumber = 1;\n      \n      for (let season = 1; season <= tvData.number_of_seasons; season++) {\n        console.log(`[MultiProvider] Fetching season ${season}...`);\n        const seasonUrl = `https://api.themoviedb.org/3/tv/${tmdbId}/season/${season}?api_key=${this.tmdbApiKey}`;\n        const seasonResponse = await fetch(seasonUrl);\n        const seasonData = await seasonResponse.json();\n        \n        if (!seasonData || !seasonData.episodes) {\n          console.warn(`[MultiProvider] No episodes for season ${season}`);\n          continue;\n        }\n        \n        console.log(`[MultiProvider] Season ${season} has ${seasonData.episodes.length} episodes`);\n        \n        for (const ep of seasonData.episodes) {\n          episodes.push({\n            id: `${Id}/${season}/${ep.episode_number}`,\n            number: absoluteEpisodeNumber,\n            title: ep.name || `Episode ${absoluteEpisodeNumber}`,\n            url: \"\",\n          });\n          absoluteEpisodeNumber++;\n        }\n      }\n      \n      console.log(`[MultiProvider] Total episodes: ${episodes.length}`);\n      return episodes;\n    } catch (err) {\n      console.error(\"[MultiProvider] findEpisodes error:\", err);\n      return [];\n    }\n  }\n\n  async findEpisodeServer(episode, server) {\n    try {\n      console.log(`[MultiProvider] findEpisodeServer: ${episode.id}, server: ${server}`);\n      \n      const parts = episode.id.split(\"/\");\n      const tmdbId = parts[0];\n      const mediaType = parts[1];\n      const season = parts[2] || \"1\";\n      const ep = parts[3] || \"1\";\n      \n      console.log(`[MultiProvider] Parsed - TMDB: ${tmdbId}, Type: ${mediaType}, Season: ${season}, Episode: ${ep}`);\n      \n      let embedUrl;\n      let referer;\n      \n      switch (server) {\n        case \"VidSrc.to\":\n          if (mediaType === \"movie\") {\n            embedUrl = `https://vidsrc.to/embed/movie/${tmdbId}`;\n          } else {\n            embedUrl = `https://vidsrc.to/embed/tv/${tmdbId}/${season}/${ep}`;\n          }\n          referer = \"https://vidsrc.to/\";\n          break;\n          \n        case \"VidSrc.cc\":\n          if (mediaType === \"movie\") {\n            embedUrl = `https://vidsrc.cc/v2/embed/movie/${tmdbId}`;\n          } else {\n            embedUrl = `https://vidsrc.cc/v2/embed/tv/${tmdbId}/${season}/${ep}`;\n          }\n          referer = \"https://vidsrc.cc/\";\n          break;\n          \n        case \"2Embed\":\n          if (mediaType === \"movie\") {\n            embedUrl = `https://www.2embed.cc/embed/${tmdbId}`;\n          } else {\n            embedUrl = `https://www.2embed.cc/embedtv/${tmdbId}&s=${season}&e=${ep}`;\n          }\n          referer = \"https://www.2embed.cc/\";\n          break;\n          \n        case \"SuperEmbed\":\n          if (mediaType === \"movie\") {\n            embedUrl = `https://multiembed.mov/?video_id=${tmdbId}&tmdb=1`;\n          } else {\n            embedUrl = `https://multiembed.mov/?video_id=${tmdbId}&tmdb=1&s=${season}&e=${ep}`;\n          }\n          referer = \"https://multiembed.mov/\";\n          break;\n          \n        default:\n          throw new Error(`Unknown server: ${server}`);\n      }\n      \n      console.log(`[MultiProvider] Embed URL: ${embedUrl}`);\n      console.log(`[MultiProvider] NOTE: This is an iframe embed - SeAnime may or may not support it`);\n      \n      return {\n        server: server,\n        headers: {\n          \"Referer\": referer,\n        },\n        videoSources: [{\n          url: embedUrl,\n          type: \"iframe\",\n          quality: \"auto\",\n          subtitles: [],\n        }],\n      };\n    } catch (err) {\n      console.error(\"[MultiProvider] findEpisodeServer error:\", err);\n      throw err;\n    }\n  }\n}"
}
